<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova AI - Blacnova Workspace</title>
    <link rel="icon" href="https://www.blacnova.net/img/bn_orange.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />

    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_midnight.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --primary: #df722d;
            --primary-light: #e88b4b;
            --dark-bg: #101010;
            --card-bg: #1a1a1a;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        html, body {
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #EEEEEE;
            background-image: radial-gradient(circle at 50% 0%, rgba(212, 97, 28, 0.1), transparent 40%);
        }
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.7;
        }
        .text-gradient {
            background: linear-gradient(to right, #ffffff, #efad83);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* Shimmer effect */
        .shimmer {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* PrismJS custom styles */
        pre[class*="language-"] {
            background: rgba(0,0,0,0.5) !important;
            border-radius: 0.75rem !important;
            border: 1px solid var(--border-color) !important;
            position: relative;
        }
        .prose code::before, .prose code::after { content: none; }
        .tabulator { border: 1px solid var(--border-color) !important; }
        .tabulator-header { background-color: rgba(0,0,0,0.3) !important; }

        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 10;
        }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="flex h-screen w-screen" x-data="app()">

    <canvas id="three-canvas"></canvas>

    <template x-if="auth.isLoggedIn">
        <div class="flex flex-col h-full w-full relative" x-data="aiChat(auth.user)" x-cloak>
            <header class="absolute top-0 left-0 w-full z-20 backdrop-blur-md bg-transparent">
                <div class="container mx-auto px-6">
                    <div class="flex justify-between items-center h-24 border-b border-white/10">
                        <a href="#" class="flex items-center">
                            <img src="https://www.blacnova.net/img/logo_white.png" alt="Blacnova Logo" class="h-16">
                        </a>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <p class="font-bold text-white" x-text="user ? user.full_name : ''"></p>
                                <p class="text-xs text-gray-400" x-text="user ? user.email : ''"></p>
                            </div>
                            <div class="dropdown dropdown-end">
                                <div tabindex="0" role="button" class="avatar placeholder">
                                    <div class="bg-neutral text-neutral-content rounded-full w-12">
                                        <span class="text-xl" x-text="user ? user.full_name.charAt(0).toUpperCase() : ''"></span>
                                    </div>
                                </div>
                                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                    <li><a @click="$store.auth.logout()">Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main id="chat-container" x-ref="chatContainer" class="flex-1 pt-32 pb-40 overflow-y-auto custom-scrollbar">
                <div class="container mx-auto px-6 space-y-8">
                    
                    <div x-show="messages.length === 0" class="text-center py-16">
                        <div class="inline-block p-4 bg-white/5 border border-white/10 rounded-2xl mb-6">
                            <img src="https://www.blacnova.net/img/bn_orange.png" class="h-12 w-12" alt="Nova Logo">
                        </div>
                        <h1 class="text-5xl font-bold text-gradient font-['Space_Grotesk'] mb-4">How can I help you today?</h1>
                    </div>

                    <template x-for="(message, index) in messages" :key="index">
                        <div :class="message.role === 'user' ? 'flex justify-end' : 'flex justify-start items-start'">
                            <div x-show="message.role === 'assistant'" class="avatar mr-4 flex-shrink-0">
                                <div class="w-12 h-12 rounded-full bg-[var(--card-bg)] flex items-center justify-center">
                                   <img src="https://www.blacnova.net/img/bn_orange.png" class="h-8 w-8" alt="Nova AI Avatar">
                                </div>
                            </div>

                            <div class="max-w-4xl w-full" :class="{'max-w-2xl': message.role === 'user'}">
                                <div class="p-5 rounded-2xl shadow-lg" 
                                     :class="{
                                        'bg-[var(--primary)] text-white': message.role === 'user',
                                        'bg-[var(--card-bg)] border border-white/10': message.role === 'assistant'
                                     }">
                                    <div x-show="!message.type" class="prose prose-invert max-w-none" x-html="renderMarkdown(message.content)"></div>
                                    
                                    <div x-show="message.type === 'chart'">
                                        <canvas :id="'chart-' + index"></canvas>
                                    </div>

                                    <div x-show="message.type === 'table'" :id="'table-' + index"></div>

                                    <div x-show="message.type === 'thinking'">
                                        <div class="space-y-3">
                                           <div class="h-4 w-3/4 rounded shimmer"></div>
                                           <div class="h-4 w-1/2 rounded shimmer"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </main>

            <footer class="absolute bottom-0 left-0 w-full z-10 p-6">
                <div class="container mx-auto">
                    <div class="flex items-center bg-black/30 backdrop-blur-xl border border-white/10 rounded-full p-3 shadow-2xl transition-all duration-300 focus-within:border-primary/50">
                        <button class="btn btn-circle btn-ghost">
                            <i class="fas fa-paperclip text-xl text-gray-400"></i>
                        </button>
                        <input type="text" x-model="userInput" @keydown.enter="sendMessage" placeholder="Ask Nova anything..." class="w-full bg-transparent focus:outline-none focus:bg-transparent focus:text-white mx-2 text-lg">
                        <button @click="sendMessage" class="btn btn-circle bg-[#df722d] hover:bg-[#e88b4b] border-none transition-transform duration-200 hover:scale-110" :disabled="isLoading">
                            <i class="fas fa-arrow-up text-xl text-white"></i>
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </template>
    
    <template x-if="!auth.isLoggedIn">
        <div class="w-full h-full flex items-center justify-center" x-data="authForm()" x-cloak>
            <div class="w-full max-w-md p-8 space-y-6 bg-card-bg border border-white/10 rounded-2xl shadow-2xl backdrop-blur-lg bg-black/20">
                <div class="text-center">
                    <img src="https://www.blacnova.net/img/bn_orange.png" class="h-16 w-16 mx-auto mb-4" alt="Nova Logo">
                    <h1 class="text-3xl font-bold text-gradient font-['Space_Grotesk']" x-text="isLogin ? 'Welcome Back' : 'Create an Account'"></h1>
                    <p class="text-gray-400" x-text="isLogin ? 'Sign in to continue to Nova AI' : 'Get started with your AI assistant'"></p>
                </div>
                
                <form @submit.prevent="isLogin ? login() : register()">
                    <div class="space-y-4">
                        <div class="form-control" x-show="!isLogin">
                            <label class="label"><span class="label-text text-gray-300">Full Name</span></label>
                            <input type="text" x-model="fullName" placeholder="John Doe" class="input input-bordered w-full bg-white/5 focus:border-primary">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-gray-300">Email</span></label>
                            <input type="email" x-model="email" placeholder="john.doe@email.com" class="input input-bordered w-full bg-white/5 focus:border-primary" required>
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-gray-300">Password</span></label>
                            <input type="password" x-model="password" placeholder="••••••••" class="input input-bordered w-full bg-white/5 focus:border-primary" required>
                        </div>
                    </div>

                    <div class="form-control mt-6">
                        <button type="submit" class="btn bg-[#df722d] hover:bg-[#e88b4b] border-none text-white w-full" :disabled="loading">
                            <span x-show="loading" class="loading loading-spinner"></span>
                            <span x-text="isLogin ? 'Login' : 'Create Account'"></span>
                        </button>
                    </div>

                    <div x-show="error" class="text-red-500 text-sm text-center mt-4" x-text="error"></div>

                    <div class="text-center mt-6">
                        <p class="text-sm text-gray-400">
                            <span x-text="isLogin ? 'Don\'t have an account?' : 'Already have an account?'"></span>
                            <a href="#" @click.prevent="isLogin = !isLogin" class="text-primary hover:underline">
                                <span x-text="isLogin ? 'Sign Up' : 'Sign In'"></span>
                            </a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </template>


    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('auth', {
                isLoggedIn: false,
                user: null,

                async check() {
                    try {
                        const response = await fetch('/api/auth/user.php');
                        const data = await response.json();
                        if (data.isLoggedIn) {
                            this.isLoggedIn = true;
                            this.user = data.user;
                        } else {
                            this.isLoggedIn = false;
                            this.user = null;
                        }
                    } catch (error) {
                        console.error('Session check failed:', error);
                        this.isLoggedIn = false;
                        this.user = null;
                    }
                },
                
                async login(email, password) {
                    const response = await fetch('/api/auth/login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.isLoggedIn = true;
                        this.user = data.user;
                    }
                    return data;
                },
                
                async register(fullName, email, password) {
                    const response = await fetch('/api/auth/register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ full_name: fullName, email, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.isLoggedIn = true;
                        this.user = data.user;
                    }
                    return data;
                },

                async logout() {
                    await fetch('/api/auth/logout.php');
                    this.isLoggedIn = false;
                    this.user = null;
                }
            });

            Alpine.data('app', () => ({
                auth: Alpine.store('auth'),
                init() {
                    this.auth.check();
                }
            }));
            
            Alpine.data('authForm', () => ({
                isLogin: true,
                fullName: '',
                email: '',
                password: '',
                error: '',
                loading: false,
                auth: Alpine.store('auth'),

                async login() {
                    this.loading = true;
                    this.error = '';
                    const result = await this.auth.login(this.email, this.password);
                    if (!result.success) {
                        this.error = result.message;
                    }
                    this.loading = false;
                },

                async register() {
                    this.loading = true;
                    this.error = '';
                    const result = await this.auth.register(this.fullName, this.email, this.password);
                    if (!result.success) {
                        this.error = result.message;
                    }
                    this.loading = false;
                }
            }));

            Alpine.data('aiChat', (user) => ({
                user: user,
                userInput: '',
                messages: [],
                isLoading: false,

                init() {
                    mermaid.initialize({ startOnLoad: false, theme: 'dark' });
                    marked.setOptions({
                        langPrefix: 'language-',
                        gfm: true,
                    });
                },

                async sendMessage() {
                    if (this.isLoading || !this.userInput.trim()) return;

                    const userMessageContent = this.userInput;
                    this.messages.push({ role: 'user', content: userMessageContent });
                    this.userInput = '';
                    this.isLoading = true;
                    
                    this.messages.push({ role: 'assistant', type: 'thinking' });
                    const assistantMessageIndex = this.messages.length - 1;

                    try {
                        const response = await fetch('/api/chat_handler.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: userMessageContent })
                        });
                        
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            // Handle JSON for charts/tables
                            const data = await response.json();
                            this.messages.pop(); // Remove thinking indicator
                            this.handleStructuredData(data);
                        } else {
                            // Handle streaming text
                            this.messages[assistantMessageIndex].type = ''; // Switch from thinking to receiving
                            this.messages[assistantMessageIndex].content = '';
                            
                            const reader = response.body.getReader();
                            const decoder = new TextDecoder();
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                const chunk = decoder.decode(value, { stream: true });
                                this.messages[assistantMessageIndex].content += chunk;
                                this.scrollToBottom();
                            }
                        }
                    } catch (error) {
                         this.messages.pop(); // Remove thinking indicator on error
                         this.messages.push({ role: 'assistant', content: 'Sorry, there was an error connecting to the AI.' });
                         console.error('Send message error:', error);
                    } finally {
                        this.isLoading = false;
                        this.$nextTick(() => {
                           this.highlightCode();
                           this.renderDiagrams();
                        });
                    }
                },

                handleStructuredData(data) {
                    if (data.type === 'chart') {
                        const messageIndex = this.messages.length;
                        this.messages.push({ role: 'assistant', type: 'chart', content: '', chartData: data });
                        this.$nextTick(() => this.renderChart(messageIndex, data));
                    } else if (data.type === 'table') {
                        const messageIndex = this.messages.length;
                        this.messages.push({ role: 'assistant', type: 'table', content: '', tableData: data });
                         this.$nextTick(() => this.renderTable(messageIndex, data));
                    }
                },
                
                renderChart(index, chartData) {
                    const ctx = document.getElementById('chart-' + index);
                    if (ctx) {
                        new Chart(ctx, {
                            type: chartData.chart_type,
                            data: chartData.data,
                            options: chartData.options
                        });
                    }
                },
                
                renderTable(index, tableData) {
                    const tableEl = document.getElementById('table-' + index);
                    if(tableEl) {
                        new Tabulator(tableEl, {
                            data: tableData.data,
                            columns: tableData.columns,
                            layout: "fitColumns",
                        });
                    }
                },
                
                renderMarkdown(content) {
                    const rawHtml = marked.parse(content || '');
                    return DOMPurify.sanitize(rawHtml, {
                        ADD_ATTR: ['class'],
                        ADD_TAGS: ['pre', 'code']
                    });
                },

                highlightCode() {
                    this.$el.querySelectorAll('pre code:not(.prism-highlighted)').forEach((block) => {
                        Prism.highlightElement(block);
                        block.classList.add('prism-highlighted');
                    });
                },
                
                renderDiagrams() {
                    this.$el.querySelectorAll('.mermaid:not([data-processed="true"])').forEach((el) => {
                        const id = `mermaid-diagram-${Date.now()}-${Math.random()}`;
                        mermaid.render(id, el.textContent, (svgCode) => {
                            el.innerHTML = svgCode;
                            el.setAttribute('data-processed', 'true');
                        });
                    });
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        this.$refs.chatContainer.scrollTop = this.$refs.chatContainer.scrollHeight;
                    });
                },
            }));
        });
    </script>
    
    <script type="module">
        // --- Standalone Scripts ---

        // Three.js background
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const group = new THREE.Group();
        scene.add(group);
        const particlesGeometry = new THREE.BufferGeometry();
        const count = 2000;
        const positions = new Float32Array(count * 3);
        for (let i = 0; i < count * 3; i++) {
            positions[i] = (Math.random() - 0.5) * 15;
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.03,
            sizeAttenuation: true,
            color: 0xdf722d,
            transparent: true,
            opacity: 0.7
        });
        const particles = new THREE.Points(particlesGeometry, particlesMaterial);
        group.add(particles);
        camera.position.z = 5;
        const clock = new THREE.Clock();
        const animate = () => {
            const elapsedTime = clock.getElapsedTime();
            group.rotation.y = elapsedTime * 0.05;
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        };
        animate();
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });
        
        // Copy to clipboard functionality for code blocks
        document.addEventListener('click', function(e) {
            const copyCodeBtn = e.target.closest('.copy-code-btn');
            if (copyCodeBtn) {
                const pre = copyCodeBtn.parentElement.querySelector('pre');
                if (pre) {
                    const code = pre.innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        copyCodeBtn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                        setTimeout(() => {
                            copyCodeBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                }
            }
        });
    </script>
</body>
</html>
